@using PersianDatePickerSample.Components.PersianDatePickerComponent


<div class="Persian-date-picker">
    <div class="input-wrapper">
        <input class="p-date"
               value="@manualInput"
               @onkeydown="HandleKeyDown"
               @onfocus="() => manualInput = selectedDateInPersianFormat"
               @onclick="OpenPicker" />

        <a @onclick="Clear" class="clear">&#10006;</a>
    </div>

    @if (!string.IsNullOrEmpty(validationMessage))
    {
        <div style="color: red; font-size: 12px;">@validationMessage</div>
    }

    @if (openPicker)
    {
        <div class="Persian-date-wrapper">
            @if (monthMode)
            {
                <div class="month-select">
                    @foreach (var item in PersianDateHelper.GetMonths())
                    {
                        <a @onclick="() => GoToMonth(item.MonthNumber)">@item.MonthName</a>
                    }
                </div>
            }
            else if (yearMode)
            {
                <div class="year-select">
                    @for (int i = curYear; i >= 1380; i--)
                    {
                        var year = i;
                        <a @onclick="() => GoToYear(year)">@i</a>
                    }
                </div>
            }
            else
            {
                <div class="year">
                    <a @onclick="NextYear" class="navigation">&#8249;</a>
                    <span @onclick="YearMode">@currentYear</span>
                    <a @onclick="PrevYear" class="navigation">&#8250;</a>
                </div>

                <div class="month">
                    <a @onclick="NextMonth" class="navigation">&#8249;</a>
                    <span @onclick="MonthMode">@monthName</span>
                    <a @onclick="PrevMonth" class="navigation">&#8250;</a>
                </div>

                <div class="week">
                    @foreach (var name in PersianDateHelper.WeekNames)
                    {
                        <div class="day-name">
                            <span>@name</span>
                        </div>
                    }

                    @foreach (var item in cells)
                    {
                        var dayClass = item.Show ? "day" : "";

                        if (selectedDate.HasValue && item.Show && selectedDate.Value.Date == item.Date.Date)
                            dayClass = $"{dayClass} current";

                        <div class="@dayClass">
                            @if (item.Show)
                            {
                                <a @onclick="() => SelectDate(item.Date)">@item.Day</a>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>


@code
{



    [Parameter]
    public DateTime? Date { get; set; }

    [Parameter]
    public EventCallback<DateTime?> DateChanged { get; set; }

    DateTime? selectedDate;
    string selectedDateInPersianFormat = string.Empty;
    System.Globalization.PersianCalendar pc = new();
    string manualInput = string.Empty;
    string validationMessage = string.Empty; // پیام اعتبارسنجی
    List<DateCellModel> cells = new();
    string monthName = string.Empty;
    int currentMonth;
    int currentYear;
    int currentDay;
    bool monthMode, yearMode, openPicker;

    int curYear;//سال جاری

    protected override void OnInitialized()
    {
        curYear = pc.GetYear(DateTime.Now);
        if (Date.HasValue)
            SetPersianFormatText(Date.Value);
    }

    // مدیریت ورودی دستی
    void HandleManualInput(ChangeEventArgs e)
    {

        var input = e.Value?.ToString()?.Trim();

        // اعتبارسنجی اولیه: خالی بودن ورودی
        if (string.IsNullOrEmpty(input))
        {
            validationMessage = "ورودی خالی است!";
            return;
        }

        // تقسیم تاریخ به بخش های مختلف
        var parts = input.Split('/');
        if (parts.Length != 3)
        {
            validationMessage = "فرمت ورودی معتبر نیست! فرمت صحیح: روز/ماه/سال.";
            return;
        }

        // مقداردهی متغیرهای روز، ماه و سال
        if (!int.TryParse(parts[0], out int year) ||
            !int.TryParse(parts[1], out int month) ||
            !int.TryParse(parts[2], out int day))
        {
            validationMessage = "مقادیر وارد شده باید عدد باشند.";
            return;
        }

        // ذخیره مقادیر پیش فرض در متغیرها
        currentDay = day;
        currentMonth = month;
        currentYear = year;

        // بررسی اعتبار مقادیر ماه
        if (currentMonth < 1 || currentMonth > 12)
        {
            validationMessage = "ماه وارد شده معتبر نیست (باید بین 1 تا 12 باشد).";
            return;
        }

        // بررسی اعتبار روز
        int maxDays = GetDaysInMonth(currentYear, currentMonth);
        if (currentDay < 1 || currentDay > maxDays)
        {
            validationMessage = $"روز وارد شده معتبر نیست (باید بین 1 تا {maxDays} باشد).";
            return;
        }

        try
        {
            // ساخت تاریخ انتخاب شده
            selectedDate = new DateTime(currentYear, currentMonth, currentDay, pc);

            // بروزرسانی تقویم
            PrepareCells(selectedDate.Value);
            validationMessage = string.Empty; // حذف پیام های خطا
            SetPersianFormatText(selectedDate.Value);
            Date = selectedDate;
            DateChanged.InvokeAsync(selectedDate);
        }
        catch (Exception ex)
        {
            validationMessage = $"خطا در تنظیم تاریخ: {ex.Message}";
        }
    }

    void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key.Length == 1 && char.IsDigit(e.Key[0]))
        {
            string digitsOnly = new(manualInput.Where(char.IsDigit).ToArray());

            if (digitsOnly.Length == 0 && e.Key != "1")
                return;

            // محدودیت طول ورودی
            if (digitsOnly.Length >= 8)
                return;

            // جلوگیری از ورود بیش از یک بار 1 در اول
            if (digitsOnly.Length == 0 && e.Key == "1")
            {
                digitsOnly += "1";
            }
            else if (digitsOnly.Length > 0)
            {
                digitsOnly += e.Key;
            }

            manualInput = FormatDateInput(digitsOnly);

            if (digitsOnly.Length == 8)
            {
                TryParseManualInput(digitsOnly);
            }
        }
        else if (e.Key == "Backspace")
        {
            string digitsOnly = new(manualInput.Where(char.IsDigit).ToArray());
            if (digitsOnly.Length > 0)
                digitsOnly = digitsOnly[..^1];

            manualInput = FormatDateInput(digitsOnly);
        }

        validationMessage = string.Empty;
    }

    string FormatDateInput(string digits)
    {
        var builder = new System.Text.StringBuilder("____/__/__");
        int index = 0;

        for (int i = 0; i < builder.Length && index < digits.Length; i++)
        {
            if (builder[i] == '_')
            {
                builder[i] = digits[index];
                index++;
            }
        }

        return builder.ToString();
    }

    void TryParseManualInput(string digitsOnly)
    {
        if (digitsOnly.Length != 8)
            return;

        if (!int.TryParse(digitsOnly[..4], out int year) ||
            !int.TryParse(digitsOnly.Substring(4, 2), out int month) ||
            !int.TryParse(digitsOnly.Substring(6, 2), out int day))
        {
            validationMessage = "فرمت تاریخ نامعتبر است.";
            return;
        }

        if (month < 1 || month > 12)
        {
            validationMessage = "ماه نامعتبر است.";
            return;
        }

        int maxDays = GetDaysInMonth(year, month);
        if (day < 1 || day > maxDays)
        {
            validationMessage = $"روز نامعتبر است. باید بین 1 تا {maxDays} باشد.";
            return;
        }

        try
        {
            selectedDate = new DateTime(year, month, day, pc);
            Date = selectedDate;
            DateChanged.InvokeAsync(selectedDate);
            SetPersianFormatText(selectedDate.Value);
            PrepareCells(selectedDate.Value);
            openPicker = false;
        }
        catch (Exception ex)
        {
            validationMessage = $"خطا در ساخت تاریخ: {ex.Message}";
        }
    }


    void SetPersianFormatText(DateTime date)
    {
        currentYear = pc.GetYear(date);
        currentMonth = pc.GetMonth(date);
        currentDay = pc.GetDayOfMonth(date);
        selectedDateInPersianFormat = $"{currentYear}/{currentMonth.ToString("D2")}/{currentDay.ToString("D2")}";
    }

    void Clear()
    {
        Date = selectedDate = null;
        selectedDateInPersianFormat = string.Empty;
        validationMessage = string.Empty;
        openPicker = false;
        DateChanged.InvokeAsync(null);

    }

    void OpenPicker()
    {
        if (openPicker)
        {
            openPicker = false;
            return;
        }

        selectedDate = Date.HasValue ? Date : DateTime.Now;
        PrepareCells(selectedDate.Value);
        openPicker = true;
    }

    void PrepareCells(DateTime date)
    {
        cells = new();
        currentYear = pc.GetYear(date);
        currentMonth = pc.GetMonth(date);
        currentDay = pc.GetDayOfMonth(date);
        var isLeapYear = pc.IsLeapYear(currentYear);

        monthName = $"{currentMonth.GetMonthName()}";
        selectedDateInPersianFormat = $"{currentYear}/{currentMonth.ToString("D2")}/{currentDay.ToString("D2")}";

        var firstDayOfDate = new DateTime(currentYear, currentMonth, 1, pc);
        int weekSpan = firstDayOfDate.DayOfWeek.GetWeekSpan();

        var maxDay = currentMonth <= 6 ? 31 : 30;
        if (!isLeapYear && currentMonth == 12 && maxDay == 30)
        {
            maxDay = 29;
        }

        for (int i = 1; i <= weekSpan; i++)
        {
            cells.Add(new DateCellModel
                {
                    Day = 0
                });
        }

        for (int i = 1; i <= maxDay; i++)
        {
            cells.Add(new DateCellModel
                {
                    Day = i,
                    Date = firstDayOfDate.AddDays(i - 1)
                });
        }

        var remain = 42 - cells.Count();

        if (remain > 0)
        {
            for (int i = 1; i <= remain; i++)
            {
                cells.Add(new DateCellModel
                    {
                        Day = 0
                    });
            }
        }
    }

    void SelectDate(DateTime date)
    {
        selectedDate = Date = date;
        openPicker = false;
        DateChanged.InvokeAsync(selectedDate);
        SetPersianFormatText(Date.Value);
    }

    // متد کمکی برای دریافت تعداد روزهای ماه
    int GetDaysInMonth(int year, int month)
    {
        return pc.GetDaysInMonth(year, month);
    }

    #region [ Month ]

    void NextMonth()
    {

        if (currentMonth < 12)
        {
            currentMonth++;
        }
        else
        {
            currentMonth = 1;
            currentYear++;
        }

        int lastDayOfMonth = GetDaysInMonth(currentYear, currentMonth);
        currentDay = currentDay > lastDayOfMonth ? lastDayOfMonth : currentDay;

        try
        {
            selectedDate = new DateTime(currentYear, currentMonth, currentDay, pc);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"خطا در تنظیم تاریخ: {ex.Message}");
            selectedDate = new DateTime(currentYear, currentMonth, 1, pc);
        }

        PrepareCells(selectedDate.Value);
    }

    void PrevMonth()
    {
        if (currentMonth > 1)
        {
            currentMonth--;
        }
        else
        {
            currentMonth = 12;
            currentYear--;
        }

        int lastDayOfMonth = GetDaysInMonth(currentYear, currentMonth);
        currentDay = currentDay > lastDayOfMonth ? lastDayOfMonth : currentDay;

        try
        {
            selectedDate = new DateTime(currentYear, currentMonth, currentDay, pc);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"خطا در تنظیم تاریخ: {ex.Message}");
            selectedDate = new DateTime(currentYear, currentMonth, 1, pc);
        }

        PrepareCells(selectedDate.Value);
    }

    void GoToMonth(int month)
    {
        currentMonth = month;
        selectedDate = new DateTime(currentYear, currentMonth, currentDay, pc);
        if (currentMonth == 12 && !pc.IsLeapYear(currentYear) && currentDay > 29)
            currentDay = 1;

        monthMode = yearMode = false;
        PrepareCells(selectedDate.Value);
    }

    void MonthMode()
    {
        monthMode = true;
        yearMode = false;
    }

    #endregion [ Month ]

    #region [ Year ]

    void NextYear()
    {
        currentYear++;

        int lastDayOfMonth = GetDaysInMonth(currentYear, currentMonth);
        currentDay = currentDay > lastDayOfMonth ? lastDayOfMonth : currentDay;

        try
        {
            selectedDate = new DateTime(currentYear, currentMonth, currentDay, pc);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"خطا در تنظیم تاریخ: {ex.Message}");
            selectedDate = new DateTime(currentYear, currentMonth, 1, pc);
        }

        PrepareCells(selectedDate.Value);
    }

    void PrevYear()
    {

        if (currentMonth == 1)
        {
            currentMonth = 12;
            currentYear--;
        }
        else
        {
            currentMonth--;
        }

        int lastDayOfMonth = GetDaysInMonth(currentYear, currentMonth);
        currentDay = currentDay > lastDayOfMonth ? lastDayOfMonth : currentDay;

        try
        {
            selectedDate = new DateTime(currentYear, currentMonth, currentDay, pc);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"خطا در تنظیم تاریخ: {ex.Message}");
            selectedDate = new DateTime(currentYear, currentMonth, 1, pc);
        }

        PrepareCells(selectedDate.Value);
    }

    void GoToYear(int year)
    {
        currentYear = year;
        selectedDate = new DateTime(currentYear, currentMonth, currentDay, pc);
        if (currentMonth == 12 && !pc.IsLeapYear(currentYear) && currentDay > 29)
            currentDay = 1;

        monthMode = yearMode = false;
        PrepareCells(selectedDate.Value);
    }

    void YearMode()
    {
        yearMode = true;
        monthMode = false;
    }

    #endregion [ Year ]

}
